# V8引擎下的"数组"底层实现

## 数组描述

| 数组     | 描述                                                         |
| :------- | :----------------------------------------------------------- |
| 传统数组 | 相同数据类型, 连续内存, 连续空间存储, 线性存储结构, 固定长度 |
| JS数组   | 多种数据类型, 动态容量

## JS数组

> 新建数组时, 没有设置容量, 默认Fast Elements 模式
> 设置容量, 没有进行内部元素初始化(`new Array(10)`), 出现空洞, 将会以**Fast Holey Elements**模式实现
> 对数组进行初始化, `Fast Elements`模式实现, 不存在空洞

### FixedArray 快数组(默认)

> 特点:
>
> - 数组长度: `length < elements.length()`
>
> - 线性存储方式 (默认)
> - 长度可变
> - 可扩容: 扩容后的新容量= 旧容量*1.5 + 16, 扩容后会将拷贝到新的内存空间中
> - 可缩放:如果容量> length*2+16, 就进行收缩容量调整, 否则用holes对象

### HashTable 慢数组

> 特点:
>
> - 以数组为键的`HashTable`
> - 字典内存形式
> - 不用连续的存储空间(节省内存)
> - 效率较低

### 快慢数组切换

> **转换为慢数组**:
>
> - `新容量>=3*拓展后的容量*2`
> - `newIndex - Now容量>=1024`
>
> **转换为快数组**:
>
> ( `smi在64位平台为-2^31到2^31-1, 在32位平台为-2^30到2^30-1`)
>
> - 数组长度在`smi`之间不可转换
> - 当慢数组的元素可存放在快数组中且长度在 smi 之间且仅节省了50%的空间,则会转变为快数组

### 补充

#### holes对象

> holes(空洞): 指数组分配了空间, 但是没有存放元素的地方
>
> - 快数组中在 **Fast Elements** 模式中的拓展模式 **Fast Holey Elements**

##### Fast Holey Elements

> 动态分配连续的存储空间, 分配空间的大小由最大的索引值决定
